name: $(date:yyyyMMdd)$(rev:.r)

trigger:
  branches:
    include:
      - refs/heads/master
  batch: True

stages:
  - stage: Build
    jobs:
      - job: Build
        timeoutInMinutes: 0
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - checkout: self
          - task: NodeTool@0
            displayName: Use Node version
            inputs:
              versionSpec: 14.15
          - task: Npm@1
            displayName: Install dependencies
            inputs:
              command: ci
              verbose: false
          - task: Npm@1
            displayName: Run tests
            inputs:
              command: custom
              verbose: false
              customCommand: run test:azure
          - task: ArchiveFiles@2
            displayName: Archive application
            inputs:
              rootFolderOrFile: $(System.DefaultWorkingDirectory)
              includeRootFolder: false
              archiveFile: $(Build.ArtifactStagingDirectory)/app-v$(Build.BuildId).zip
          - task: ArchiveFiles@2
            displayName: Archive tests
            inputs:
              rootFolderOrFile: $(System.DefaultWorkingDirectory)/coverage
              includeRootFolder: false
              archiveFile: $(Build.ArtifactStagingDirectory)/tests-v$(Build.BuildId).zip
          - task: CopyFiles@2
            displayName: Copy ARM templates
            inputs:
              SourceFolder: armTemplates
              TargetFolder: $(build.artifactstagingdirectory)
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifact: drop'
            inputs:
              TargetPath: '/my/share/$(Build.DefinitionName)/$(Build.BuildNumber)'

  - stage: Deploy
    jobs:
      - job: Build
        timeoutInMinutes: 0
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - task: AzureResourceGroupDeployment@2
            displayName: 'Azure Deployment:Create Azure App Service'
            inputs:
              azureSubscription: 'gestao-contratos-service - Azure'
              resourceGroupName: 'gestao-contratos-service-rg'
              location: 'South Central US'
              csmFile: '$(System.DefaultWorkingDirectory)/**/windows-webapp-template.json'
              overrideParameters: '-webAppName gestao-contratos-service -hostingPlanName gestao-contratos-service-plan -appInsightsLocation "South Central US" -sku "F1 Free"'

          - task: AzureRmWebAppDeployment@3
            displayName: 'Deploy Azure App Service'
            inputs:
              azureSubscription: 'gestao-contratos-service - Azure'
              WebAppName: 'gestao-contratos-service'
              Package: '$(System.DefaultWorkingDirectory)/**/app-v*.zip'
              WebAppUri: webAppUrl
              TakeAppOfflineFlag: true
              UseWebDeploy: true
              RenameFilesFlag: true
